<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>My Friends | BingeSync</title>
		<link rel="stylesheet" href="/css/friends-list.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
		/>
	</head>

	<body>
		<div class="friends-page">
			<section class="hero">
				<div class="overlay"></div>
				<img
					src="https://images.unsplash.com/photo-1544005313-94ddf0286df2?auto=format&fit=crop&w=1200&q=80"
					class="bg-image"
					alt="Friends"
				/>
				<div class="hero-content">
					<h1>ðŸŽ¬ Your Binge Buddies</h1>
					<p>See your friends and explore their watchlists!</p>
				</div>
			</section>

			<section class="friends-list">
				<h2>Friends Youâ€™re Connected With</h2>

				<% if (friends.length === 0) { %>
				<p class="empty">You haven't added any friends yet ðŸ˜…</p>
				<% } else { %>
				<div class="friends-grid">
					<% friends.forEach(friend => { %>
					<div class="friend-card">
						<div class="avatar">
							<img
								src="https://api.dicebear.com/9.x/avataaars/svg?seed=<%= friend.name %>"
								alt="<%= friend.name %>"
							/>
						</div>
						<div class="friend-info">
							<h3><%= friend.name %></h3>
							<p><%= friend.email %></p>
						</div>
						<div class="actions">
							<a
								href="/watchlist/friends/watchlist/<%= friend.id %>"
								class="btn view-btn"
							>
								<i class="fa-solid fa-tv"></i> View Watchlist
							</a>
							<button
								class="btn remove-btn"
								onclick="removeFriend('<%= friend.id %>')"
							>
								<i class="fa-solid fa-user-xmark"></i> Remove
							</button>
						</div>
					</div>
					<% }) %>
				</div>
				<% } %>
			</section>
		</div>

		<div id="toast-confirm" class="toast-confirm">
			<p id="toast-message"></p>
			<div class="toast-actions">
				<button id="toast-yes" class="btn">Yes</button>
				<button id="toast-no" class="btn">No</button>
			</div>
		</div>

		<script>
			async function removeFriend(friendId) {
				const confirmed = await showConfirm(
					"Are you sure you want to remove this friend?"
				);
				if (!confirmed) return;

				try {
					const res = await fetch(`/watchlist/friends/remove/${friendId}`, {
						method: "DELETE",
					});

					if (res.ok) {
						// Find the friend card for this friendId
						const card = document
							.querySelector(`button[onclick="removeFriend('${friendId}')"]`)
							?.closest(".friend-card");

						if (card) {
							card.style.transition = "all 0.4s ease";
							card.style.opacity = "0";
							card.style.transform = "translateY(20px)";

							setTimeout(() => card.remove(), 400);
						}

						showToast("ðŸ‘‹ Friend removed", "success");
					} else {
						showToast("âŒ Error removing friend", "error");
					}
				} catch {
					showToast("âŒ Error removing friend", "error");
				}
			}

			// Toast confirmation
			function showConfirm(message) {
				return new Promise((resolve) => {
					const toast = document.getElementById("toast-confirm");
					const msg = document.getElementById("toast-message");
					const yesBtn = document.getElementById("toast-yes");
					const noBtn = document.getElementById("toast-no");

					msg.textContent = message;
					toast.classList.add("show");

					const cleanup = () => toast.classList.remove("show");

					yesBtn.onclick = () => {
						cleanup();
						resolve(true);
					};
					noBtn.onclick = () => {
						cleanup();
						resolve(false);
					};
				});
			}

			// Create reusable toast for messages
			function showToast(msg, type = "success") {
				let toast = document.getElementById("toast");
				if (!toast) {
					toast = document.createElement("div");
					toast.id = "toast";
					toast.className = "toast";
					document.body.appendChild(toast);
				}

				toast.innerHTML =
					type === "success"
						? `<i class="fa-solid fa-circle-check"></i> ${msg}`
						: `<i class="fa-solid fa-circle-xmark"></i> ${msg}`;

				toast.classList.add("show");
				setTimeout(() => toast.classList.remove("show"), 3000);
			}
		</script>
	</body>
</html>
